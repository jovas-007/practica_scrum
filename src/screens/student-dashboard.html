<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Estudiante - Sistema de Gesti贸n de Tareas</title>
    <link rel="stylesheet" href="../assets/dise帽os.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            font-size: 14px;
        }

        .badge-estudiante {
            background: #002855;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Layout */
        .main-container {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #0f172a;
            padding: 20px 0;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            padding: 0;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 25px;
            color: #94a3b8;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border-left-color: #10b981;
        }

        .sidebar-menu .icon {
            font-size: 20px;
            width: 25px;
            text-align: center;
        }

        /* Content Area */
        .content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .card-title {
            font-size: 20px;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card.warning { background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); }
        .stat-card.success { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
        .stat-card.info { background: linear-gradient(135deg, #002855 0%, #004080 100%); }
        .stat-card.danger { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Badges */
        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-pendiente { background: #fef3c7; color: #92400e; }
        .badge-entregado { background: #dbeafe; color: #1e40af; }
        .badge-calificado { background: #d1fae5; color: #065f46; }
        .badge-vencida { background: #fee2e2; color: #991b1b; }
        .badge-tardia { background: #fef3c7; color: #92400e; }

        /* Task Cards */
        .task-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .task-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #059669;
            transition: all 0.3s;
        }

        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .task-card.vencida {
            border-left-color: #dc2626;
        }

        .task-card.entregada {
            border-left-color: #3b82f6;
        }

        .task-card.calificada {
            border-left-color: #059669;
        }

        .task-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .task-card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .task-card-meta {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 15px;
        }

        .task-card-meta span {
            display: block;
            margin-bottom: 5px;
        }

        .task-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 20px;
            color: #1e293b;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Task Detail */
        .task-detail-section {
            margin-bottom: 25px;
        }

        .task-detail-section h4 {
            color: #374151;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-description {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.6;
            color: #475569;
        }

        .resource-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s;
        }

        .resource-link:hover {
            background: #bfdbfe;
        }

        /* File Upload */
        .file-upload-area {
            border: 2px dashed #e2e8f0;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8fafc;
        }

        .file-upload-area:hover {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .file-upload-area.dragover {
            border-color: #10b981;
            background: #d1fae5;
        }

        .file-upload-area input {
            display: none;
        }

        .file-upload-area .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .uploaded-files {
            margin-top: 20px;
        }

        .uploaded-file {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .uploaded-file .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .uploaded-file .remove-file {
            background: #fee2e2;
            border: none;
            color: #dc2626;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Calificaci贸n Display */
        .grade-display {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .grade-display .grade-value {
            font-size: 48px;
            font-weight: 700;
            color: #059669;
        }

        .grade-display.low .grade-value {
            color: #dc2626;
        }

        .grade-display.medium .grade-value {
            color: #d97706;
        }

        .grade-display .grade-label {
            font-size: 14px;
            color: #64748b;
            margin-top: 5px;
        }

        .feedback-box {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #059669;
        }

        .feedback-box h5 {
            color: #374151;
            margin-bottom: 10px;
        }

        /* Previous Submissions */
        .submission-history {
            margin-top: 20px;
        }

        .submission-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .submission-item .file-name {
            color: #1e293b;
            font-weight: 500;
        }

        .submission-item .file-date {
            font-size: 12px;
            color: #64748b;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state .icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 20px;
            color: #1e293b;
            margin-bottom: 10px;
        }

        /* Alert */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success { background: #d1fae5; color: #065f46; }
        .alert-error { background: #fee2e2; color: #991b1b; }
        .alert-warning { background: #fef3c7; color: #92400e; }
        .alert-info { background: #dbeafe; color: #1e40af; }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #e2e8f0;
            border-top-color: #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Calificaciones Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #475569;
        }

        .grade-cell {
            font-weight: 700;
            text-align: center;
        }

        .grade-cell.high { color: #059669; }
        .grade-cell.medium { color: #d97706; }
        .grade-cell.low { color: #dc2626; }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .task-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1> Sistema de Gesti贸n de Tareas</h1>
        <div class="user-info">
            <span id="userName">Cargando...</span>
            <span class="badge-estudiante">ESTUDIANTE</span>
            <button class="btn-logout" onclick="logout()"> Cerrar Sesi贸n</button>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <ul class="sidebar-menu">
                <li>
                    <a href="#" class="active" onclick="showSection('dashboard')">
                        <span class="icon"></span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showSection('tareas-pendientes')">
                        <span class="icon"></span>
                        <span>Tareas Pendientes</span>
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showSection('tareas-entregadas')">
                        <span class="icon"></span>
                        <span>Tareas Entregadas</span>
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showSection('mis-calificaciones')">
                        <span class="icon"></span>
                        <span>Mis Calificaciones</span>
                    </a>
                </li>
            </ul>
            <li>
                <a href="./graficas.html">
                 <span class="icon"></span>
                <span>Gr谩ficas</span>
                </a>
            </li>
        </nav>

        <!-- Content -->
        <main class="content">
            <!-- Dashboard Section -->
            <section id="section-dashboard" class="section active">
                <div class="stats-grid">
                    <div class="stat-card warning">
                        <div class="stat-value" id="totalPendientes">0</div>
                        <div class="stat-label">Pendientes</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-value" id="totalEntregadas">0</div>
                        <div class="stat-label">Entregadas</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-value" id="totalCalificadas">0</div>
                        <div class="stat-label">Calificadas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="promedioGeneral">-</div>
                        <div class="stat-label">Promedio</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"> Tareas Pr贸ximas a Vencer</h2>
                    </div>
                    <div id="tareasProximas">
                        <div class="loading">Cargando tareas</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"> ltimas Calificaciones</h2>
                    </div>
                    <div id="ultimasCalificaciones">
                        <div class="loading">Cargando</div>
                    </div>
                </div>
            </section>

            <!-- Tareas Pendientes Section -->
            <section id="section-tareas-pendientes" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"> Tareas Pendientes</h2>
                    </div>
                    <div id="listaTareasPendientes" class="task-grid">
                        <div class="loading">Cargando tareas</div>
                    </div>
                </div>
            </section>

            <!-- Tareas Entregadas Section -->
            <section id="section-tareas-entregadas" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"> Tareas Entregadas</h2>
                    </div>
                    <div id="listaTareasEntregadas" class="task-grid">
                        <div class="loading">Cargando tareas</div>
                    </div>
                </div>
            </section>

            <!-- Mis Calificaciones Section -->
            <section id="section-mis-calificaciones" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"> Mis Calificaciones</h2>
                    </div>
                    <div id="tablaCalificaciones">
                        <div class="loading">Cargando calificaciones</div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Ver/Entregar Tarea -->
    <div id="modalTarea" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTareaTitulo">Detalle de Tarea</h3>
                <button class="modal-close" onclick="cerrarModal('modalTarea')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Info de calificaci贸n (si existe) -->
                <div id="seccionCalificacion" style="display: none;">
                    <div class="grade-display" id="gradeDisplay">
                        <div class="grade-value" id="gradeValue">-</div>
                        <div class="grade-label">de <span id="gradeMax">10</span> puntos</div>
                    </div>
                    <div class="feedback-box" id="feedbackBox" style="display: none;">
                        <h5> Comentario del docente:</h5>
                        <p id="feedbackText"></p>
                    </div>
                </div>

                <!-- Descripci贸n -->
                <div class="task-detail-section">
                    <h4> Descripci贸n</h4>
                    <div class="task-description" id="tareaDescripcion">
                        Sin descripci贸n
                    </div>
                </div>

                <!-- Recursos -->
                <div class="task-detail-section" id="seccionRecursos" style="display: none;">
                    <h4> Recursos del Docente</h4>
                    <div id="recursosDocente"></div>
                </div>

                <!-- Info de entrega -->
                <div class="task-detail-section">
                    <h4> Informaci贸n de Entrega</h4>
                    <p><strong>Fecha l铆mite:</strong> <span id="fechaLimite">-</span></p>
                    <p><strong>Puntos m谩ximos:</strong> <span id="puntosMax">10</span></p>
                    <p id="estadoTarea"></p>
                </div>

                <!-- rea de entrega (solo si puede entregar) -->
                <div class="task-detail-section" id="seccionEntrega" style="display: none;">
                    <h4> Entregar Tarea</h4>
                    <div class="file-upload-area" id="dropZone" onclick="document.getElementById('inputArchivos').click()">
                        <div class="icon"></div>
                        <p><strong>Arrastra archivos aqu铆</strong></p>
                        <p style="font-size: 13px; color: #64748b;">o haz clic para seleccionar</p>
                        <p style="font-size: 12px; color: #94a3b8; margin-top: 10px;">
                            PDF, DOC, PPT, im谩genes, c贸digo (m谩x. 20MB por archivo)
                        </p>
                        <input type="file" id="inputArchivos" multiple 
                               accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.zip,.rar,.txt,.py,.js,.html,.css,.java,.cpp,.c">
                    </div>

                    <div class="uploaded-files" id="archivosSeleccionados"></div>

                    <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" 
                            onclick="enviarEntrega()" id="btnEnviar" disabled>
                         Enviar Entrega
                    </button>
                </div>

                <!-- Historial de entregas -->
                <div class="task-detail-section" id="seccionHistorial" style="display: none;">
                    <h4> Historial de Entregas</h4>
                    <div class="submission-history" id="historialEntregas"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURACIN ====================
        const API_URL = 'https://grateful-sparkle-production-cac8.up.railway.app/api';
        let currentUser = null;
        let tareaActual = null;
        let archivosParaSubir = [];

        // ==================== INICIALIZACIN ====================
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar sesi贸n
            const userCookie = getCookie('currentUser');
            const userLocal = localStorage.getItem('currentUser');
            
            if (userCookie) {
                currentUser = JSON.parse(decodeURIComponent(userCookie));
            } else if (userLocal) {
                currentUser = JSON.parse(userLocal);
            }

            if (!currentUser || currentUser.rol !== 'estudiante') {
                alert('Acceso denegado. Solo estudiantes pueden acceder.');
                window.location.href = '../login.html';
                return;
            }

            document.getElementById('userName').textContent = currentUser.nombre_completo;
            
            // Configurar drag and drop
            const dropZone = document.getElementById('dropZone');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            document.getElementById('inputArchivos').addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            // Cargar datos
            cargarDashboard();
        });

        // ==================== UTILIDADES ====================
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function getHeaders() {
            return {
                'X-User-Id': currentUser.id_usuario
            };
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));

            document.getElementById(`section-${section}`).classList.add('active');
            event.target.closest('a')?.classList.add('active');

            switch(section) {
                case 'dashboard':
                    cargarDashboard();
                    break;
                case 'tareas-pendientes':
                    cargarTareasPendientes();
                    break;
                case 'tareas-entregadas':
                    cargarTareasEntregadas();
                    break;
                case 'mis-calificaciones':
                    cargarMisCalificaciones();
                    break;
            }
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            archivosParaSubir = [];
            tareaActual = null;
        }

        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = message;
            
            const content = document.querySelector('.content');
            content.insertBefore(alertDiv, content.firstChild);
            
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // ==================== DASHBOARD ====================
        async function cargarDashboard() {
            try {
                const response = await fetch(`${API_URL}/my-tasks/`, {
                    headers: getHeaders()
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('totalPendientes').textContent = data.pendientes.length;
                    document.getElementById('totalEntregadas').textContent = data.entregadas.length;
                    document.getElementById('totalCalificadas').textContent = data.calificadas.length;

                    // Mostrar tareas pr贸ximas a vencer
                    const proximas = data.pendientes
                        .filter(t => !t.esta_vencida)
                        .sort((a, b) => new Date(a.fecha_entrega) - new Date(b.fecha_entrega))
                        .slice(0, 3);
                    
                    renderTareasProximas(proximas);
                }

                // Cargar calificaciones para el promedio
                const calResponse = await fetch(`${API_URL}/my-submissions/`, {
                    headers: getHeaders()
                });
                const calData = await calResponse.json();

                if (calData.success) {
                    document.getElementById('promedioGeneral').textContent = 
                        calData.promedio ? calData.promedio.toFixed(1) : '-';
                    
                    renderUltimasCalificaciones(calData.calificaciones.slice(0, 5));
                }

            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderTareasProximas(tareas) {
            const container = document.getElementById('tareasProximas');

            if (tareas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon"></div>
                        <h3>隆Todo al d铆a!</h3>
                        <p>No tienes tareas pendientes pr贸ximas a vencer</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="task-grid">
                    ${tareas.map(t => `
                        <div class="task-card" onclick="verTarea(${t.task_id})">
                            <div class="task-card-header">
                                <span class="task-card-title">${t.titulo}</span>
                                <span class="badge badge-pendiente">PENDIENTE</span>
                            </div>
                            <div class="task-card-meta">
                                <span> Entrega: ${formatDate(t.fecha_entrega)}</span>
                                <span> ${t.puntos_maximos} puntos</span>
                            </div>
                            <div class="task-card-footer">
                                <button class="btn btn-primary btn-sm">Ver Tarea</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderUltimasCalificaciones(calificaciones) {
            const container = document.getElementById('ultimasCalificaciones');

            if (calificaciones.length === 0) {
                container.innerHTML = `
                    <p style="color: #64748b; text-align: center; padding: 20px;">
                        A煤n no tienes calificaciones
                    </p>
                `;
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Tarea</th>
                            <th style="text-align: center;">Calificaci贸n</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${calificaciones.map(c => `
                            <tr>
                                <td>${c.tarea}</td>
                                <td class="grade-cell ${c.calificacion >= 8 ? 'high' : c.calificacion >= 6 ? 'medium' : 'low'}">
                                    ${c.calificacion}/${c.puntos_maximos}
                                    ${c.es_tardia ? '<br><small style="color: #d97706;">(Tard铆a)</small>' : ''}
                                </td>
                                <td style="font-size: 13px; color: #64748b;">${formatDate(c.fecha_calificacion)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // ==================== TAREAS PENDIENTES ====================
        async function cargarTareasPendientes() {
            try {
                const response = await fetch(`${API_URL}/my-tasks/`, {
                    headers: getHeaders()
                });
                const data = await response.json();

                if (data.success) {
                    renderTareasPendientes(data.pendientes);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderTareasPendientes(tareas) {
            const container = document.getElementById('listaTareasPendientes');

            if (tareas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="icon"></div>
                        <h3>隆Sin tareas pendientes!</h3>
                        <p>Has completado todas tus tareas</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = tareas.map(t => `
                <div class="task-card ${t.esta_vencida ? 'vencida' : ''}" onclick="verTarea(${t.task_id})">
                    <div class="task-card-header">
                        <span class="task-card-title">${t.titulo}</span>
                        ${t.esta_vencida ? 
                            '<span class="badge badge-vencida">VENCIDA</span>' : 
                            '<span class="badge badge-pendiente">PENDIENTE</span>'}
                    </div>
                    <div class="task-card-meta">
                        <span> ${formatDate(t.fecha_entrega)}</span>
                        <span> ${t.puntos_maximos} puntos</span>
                    </div>
                    <p style="color: #64748b; font-size: 13px; margin: 10px 0;">
                        ${t.descripcion || 'Sin descripci贸n'}
                    </p>
                    <div class="task-card-footer">
                        <span style="font-size: 13px; color: ${t.puede_entregar ? '#059669' : '#dc2626'};">
                            ${t.puede_entregar ? ' Puede entregar' : ' No acepta entregas'}
                        </span>
                        <button class="btn btn-primary btn-sm">Ver Tarea</button>
                    </div>
                </div>
            `).join('');
        }

        // ==================== TAREAS ENTREGADAS ====================
        async function cargarTareasEntregadas() {
            try {
                const response = await fetch(`${API_URL}/my-tasks/`, {
                    headers: getHeaders()
                });
                const data = await response.json();

                if (data.success) {
                    const entregadas = [...data.entregadas, ...data.calificadas];
                    renderTareasEntregadas(entregadas);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderTareasEntregadas(tareas) {
            const container = document.getElementById('listaTareasEntregadas');

            if (tareas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="icon"></div>
                        <h3>Sin entregas a煤n</h3>
                        <p>A煤n no has entregado ninguna tarea</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = tareas.map(t => `
                <div class="task-card ${t.estado === 'calificado' ? 'calificada' : 'entregada'}" 
                     onclick="verTarea(${t.task_id})">
                    <div class="task-card-header">
                        <span class="task-card-title">${t.titulo}</span>
                        <span class="badge badge-${t.estado}">${t.estado.toUpperCase()}</span>
                    </div>
                    <div class="task-card-meta">
                        <span> ${formatDate(t.fecha_entrega)}</span>
                        ${t.calificacion ? `<span> ${t.calificacion}/${t.puntos_maximos}</span>` : ''}
                    </div>
                    <div class="task-card-footer">
                        ${t.calificacion ? 
                            `<span class="grade-cell ${t.calificacion >= 8 ? 'high' : t.calificacion >= 6 ? 'medium' : 'low'}" 
                                   style="font-size: 24px;">${t.calificacion}</span>` :
                            '<span style="color: #64748b;">Esperando calificaci贸n</span>'}
                        <button class="btn btn-secondary btn-sm">Ver Detalles</button>
                    </div>
                </div>
            `).join('');
        }

        // ==================== MIS CALIFICACIONES ====================
        async function cargarMisCalificaciones() {
            try {
                const response = await fetch(`${API_URL}/my-submissions/`, {
                    headers: getHeaders()
                });
                const data = await response.json();

                if (data.success) {
                    renderMisCalificaciones(data);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderMisCalificaciones(data) {
            const container = document.getElementById('tablaCalificaciones');

            if (data.calificaciones.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon"></div>
                        <h3>Sin calificaciones</h3>
                        <p>A煤n no tienes tareas calificadas</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px;">
                    <h2 style="color: #065f46; margin: 0;">Promedio General</h2>
                    <div style="font-size: 48px; font-weight: 700; color: ${data.promedio >= 8 ? '#059669' : data.promedio >= 6 ? '#d97706' : '#dc2626'};">
                        ${data.promedio ? data.promedio.toFixed(1) : '-'}
                    </div>
                    <p style="color: #64748b;">${data.total_calificadas} tareas calificadas</p>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Tarea</th>
                            <th style="text-align: center;">Calificaci贸n</th>
                            <th>Comentario</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.calificaciones.map(c => `
                            <tr>
                                <td>
                                    <strong>${c.tarea}</strong>
                                    ${c.es_tardia ? '<br><span class="badge badge-tardia">TARDA</span>' : ''}
                                </td>
                                <td class="grade-cell ${c.calificacion >= 8 ? 'high' : c.calificacion >= 6 ? 'medium' : 'low'}" 
                                    style="font-size: 20px;">
                                    ${c.calificacion}/${c.puntos_maximos}
                                </td>
                                <td style="max-width: 300px; font-size: 13px; color: #64748b;">
                                    ${c.comentario || '-'}
                                </td>
                                <td style="font-size: 13px; color: #64748b; white-space: nowrap;">
                                    ${formatDate(c.fecha_calificacion)}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // ==================== VER TAREA DETALLE ====================
        async function verTarea(taskId) {
            try {
                const response = await fetch(`${API_URL}/my-tasks/${taskId}/`, {
                    headers: getHeaders()
                });
                const data = await response.json();

                if (data.success) {
                    tareaActual = data.submission;
                    mostrarModalTarea(data.submission);
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert(' Error al cargar la tarea', 'error');
            }
        }

        function mostrarModalTarea(submission) {
            // T铆tulo
            document.getElementById('modalTareaTitulo').textContent = submission.tarea_titulo;
            
            // Descripci贸n
            document.getElementById('tareaDescripcion').textContent = 
                submission.tarea_descripcion || 'Sin descripci贸n';
            
            // Fecha l铆mite
            document.getElementById('fechaLimite').textContent = formatDate(submission.tarea_fecha_entrega);
            document.getElementById('puntosMax').textContent = submission.tarea_puntos_maximos;
            
            // Estado
            const estadoEl = document.getElementById('estadoTarea');
            if (submission.tarea_esta_vencida) {
                estadoEl.innerHTML = '<span style="color: #dc2626;"> Esta tarea ha vencido</span>';
            } else {
                estadoEl.innerHTML = '<span style="color: #059669;"> Tiempo disponible para entregar</span>';
            }

            // Recursos del docente
            const seccionRecursos = document.getElementById('seccionRecursos');
            const recursosHtml = [];
            
            if (submission.tarea_url_recurso) {
                recursosHtml.push(`
                    <a href="${submission.tarea_url_recurso}" target="_blank" class="resource-link">
                         Ver recurso externo
                    </a>
                `);
            }
            
            if (submission.tarea_archivo_adjunto) {
                recursosHtml.push(`
                    <a href="${API_URL.replace('/api', '')}${submission.tarea_archivo_adjunto}" 
                       target="_blank" class="resource-link" style="margin-left: 10px;">
                         Descargar archivo adjunto
                    </a>
                `);
            }

            if (recursosHtml.length > 0) {
                document.getElementById('recursosDocente').innerHTML = recursosHtml.join('');
                seccionRecursos.style.display = 'block';
            } else {
                seccionRecursos.style.display = 'none';
            }

            // Secci贸n de calificaci贸n
            const seccionCalificacion = document.getElementById('seccionCalificacion');
            if (submission.calificacion) {
                const gradeDisplay = document.getElementById('gradeDisplay');
                gradeDisplay.className = 'grade-display';
                if (submission.calificacion < 6) gradeDisplay.classList.add('low');
                else if (submission.calificacion < 8) gradeDisplay.classList.add('medium');
                
                document.getElementById('gradeValue').textContent = submission.calificacion;
                document.getElementById('gradeMax').textContent = submission.tarea_puntos_maximos;
                
                if (submission.comentario_docente) {
                    document.getElementById('feedbackText').textContent = submission.comentario_docente;
                    document.getElementById('feedbackBox').style.display = 'block';
                } else {
                    document.getElementById('feedbackBox').style.display = 'none';
                }
                
                seccionCalificacion.style.display = 'block';
            } else {
                seccionCalificacion.style.display = 'none';
            }

            // Secci贸n de entrega
            const seccionEntrega = document.getElementById('seccionEntrega');
            if (submission.puede_entregar) {
                seccionEntrega.style.display = 'block';
                archivosParaSubir = [];
                document.getElementById('archivosSeleccionados').innerHTML = '';
                document.getElementById('btnEnviar').disabled = true;
            } else {
                seccionEntrega.style.display = 'none';
            }

            // Historial de entregas
            const seccionHistorial = document.getElementById('seccionHistorial');
            if (submission.archivos && submission.archivos.length > 0) {
                document.getElementById('historialEntregas').innerHTML = submission.archivos.map(a => `
                    <div class="submission-item">
                        <div class="file-info">
                            <span></span>
                            <div>
                                <span class="file-name">${a.nombre_original}</span>
                                <span class="file-date">${formatDate(a.fecha_subida)}</span>
                                ${a.es_entrega_tardia ? '<span class="badge badge-tardia" style="margin-left: 5px;">TARDA</span>' : ''}
                            </div>
                        </div>
                        <a href="${API_URL.replace('/api', '')}${a.archivo}" target="_blank" 
                           class="btn btn-sm btn-secondary">Descargar</a>
                    </div>
                `).join('');
                seccionHistorial.style.display = 'block';
            } else {
                seccionHistorial.style.display = 'none';
            }

            document.getElementById('modalTarea').classList.add('active');
        }

        // ==================== SUBIR ARCHIVOS ====================
        function handleFiles(files) {
            const maxSize = 20 * 1024 * 1024; // 20MB
            const allowedExt = ['pdf', 'doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx', 
                               'jpg', 'jpeg', 'png', 'gif', 'zip', 'rar', 'txt',
                               'py', 'js', 'html', 'css', 'java', 'cpp', 'c'];

            for (const file of files) {
                const ext = file.name.split('.').pop().toLowerCase();
                
                if (!allowedExt.includes(ext)) {
                    showAlert(` Extensi贸n no permitida: .${ext}`, 'error');
                    continue;
                }

                if (file.size > maxSize) {
                    showAlert(` ${file.name} excede los 20MB`, 'error');
                    continue;
                }

                // Evitar duplicados
                if (!archivosParaSubir.find(f => f.name === file.name)) {
                    archivosParaSubir.push(file);
                }
            }

            renderArchivosSeleccionados();
        }

        function renderArchivosSeleccionados() {
            const container = document.getElementById('archivosSeleccionados');
            
            if (archivosParaSubir.length === 0) {
                container.innerHTML = '';
                document.getElementById('btnEnviar').disabled = true;
                return;
            }

            container.innerHTML = archivosParaSubir.map((file, index) => `
                <div class="uploaded-file">
                    <div class="file-info">
                        <span></span>
                        <div>
                            <strong>${file.name}</strong>
                            <span style="font-size: 12px; color: #64748b;">
                                (${(file.size / 1024 / 1024).toFixed(2)} MB)
                            </span>
                        </div>
                    </div>
                    <button class="remove-file" onclick="removerArchivo(${index})"></button>
                </div>
            `).join('');

            document.getElementById('btnEnviar').disabled = false;
        }

        function removerArchivo(index) {
            archivosParaSubir.splice(index, 1);
            renderArchivosSeleccionados();
        }

        async function enviarEntrega() {
            if (archivosParaSubir.length === 0) {
                showAlert(' Selecciona al menos un archivo', 'error');
                return;
            }

            const formData = new FormData();
            archivosParaSubir.forEach(file => {
                formData.append('archivos', file);
            });

            try {
                document.getElementById('btnEnviar').disabled = true;
                document.getElementById('btnEnviar').textContent = ' Enviando...';

                const response = await fetch(`${API_URL}/my-tasks/${tareaActual.task_id}/submit/?student_id=${currentUser.id_usuario}`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(` ${data.message}`);
                    cerrarModal('modalTarea');
                    
                    // Recargar la vista actual
                    const activeSection = document.querySelector('.section.active');
                    if (activeSection.id === 'section-dashboard') {
                        cargarDashboard();
                    } else if (activeSection.id === 'section-tareas-pendientes') {
                        cargarTareasPendientes();
                    }
                } else {
                    showAlert(` ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert(' Error al enviar la entrega', 'error');
            } finally {
                document.getElementById('btnEnviar').disabled = false;
                document.getElementById('btnEnviar').textContent = ' Enviar Entrega';
            }
        }

        // ==================== LOGOUT ====================
        function logout() {
            localStorage.removeItem('currentUser');
            document.cookie = 'currentUser=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = '../login.html';
        }
    </script>
</body>
</html>
