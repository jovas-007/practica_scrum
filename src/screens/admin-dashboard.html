<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Docente - Sistema de Gesti√≥n de Tareas</title>
    <link rel="stylesheet" href="../assets/dise√±os.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #002855 0%, #004080 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            font-size: 14px;
        }

        .badge-docente {
            background: #dc2626;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Layout */
        .main-container {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #0f172a;
            padding: 20px 0;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            padding: 0;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 25px;
            color: #94a3b8;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            border-left-color: #00d4ff;
        }

        .sidebar-menu .icon {
            font-size: 20px;
            width: 25px;
            text-align: center;
        }

        /* Content Area */
        .content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .card-title {
            font-size: 20px;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #002855 0%, #004080 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card.success { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
        .stat-card.warning { background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); }
        .stat-card.danger { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #002855 0%, #004080 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 64, 128, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #475569;
            font-size: 13px;
            text-transform: uppercase;
        }

        tr:hover {
            background: #f8fafc;
        }

        /* Badges */
        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-borrador { background: #fef3c7; color: #92400e; }
        .badge-activa { background: #d1fae5; color: #065f46; }
        .badge-cerrada { background: #fee2e2; color: #991b1b; }
        .badge-pendiente { background: #e0e7ff; color: #3730a3; }
        .badge-entregado { background: #dbeafe; color: #1e40af; }
        .badge-calificado { background: #d1fae5; color: #065f46; }
        .badge-tardia { background: #fef3c7; color: #92400e; }

        /* Task List */
        .task-item {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .task-item:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .task-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .task-meta {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #64748b;
            margin-bottom: 10px;
        }

        .task-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .task-stats {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .task-stat {
            font-size: 13px;
            color: #64748b;
        }

        .task-stat strong {
            color: #1e293b;
        }

        .task-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 20px;
            color: #1e293b;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Grades Table */
        .grades-table {
            font-size: 13px;
        }

        .grades-table th {
            position: sticky;
            top: 0;
            background: #f8fafc;
        }

        .grades-table .grade-cell {
            text-align: center;
            font-weight: 600;
        }

        .grade-cell.high { color: #059669; }
        .grade-cell.medium { color: #d97706; }
        .grade-cell.low { color: #dc2626; }

        .grade-input {
            width: 60px;
            padding: 5px;
            text-align: center;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #e2e8f0;
            border-top-color: #002855;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state .icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 20px;
            color: #1e293b;
            margin-bottom: 10px;
        }

        /* Alert */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success { background: #d1fae5; color: #065f46; }
        .alert-error { background: #fee2e2; color: #991b1b; }
        .alert-warning { background: #fef3c7; color: #92400e; }
        .alert-info { background: #dbeafe; color: #1e40af; }

        /* File Upload */
        .file-upload {
            border: 2px dashed #e2e8f0;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: #00d4ff;
            background: #f8fafc;
        }

        .file-upload input {
            display: none;
        }

        .file-upload .icon {
            font-size: 40px;
            color: #94a3b8;
            margin-bottom: 10px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #002855;
        }

        .tab-btn.active {
            color: #002855;
            border-bottom-color: #002855;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>üìö Sistema de Gesti√≥n de Tareas</h1>
        <div class="user-info">
            <span id="userName">Cargando...</span>
            <span class="badge-docente">DOCENTE</span>
            <button class="btn-logout" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <ul class="sidebar-menu">
                <li>
                    <a href="#" class="active" onclick="showSection('dashboard')">
                        <span class="icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showSection('crear-tarea')">
                        <span class="icon">‚ûï</span>
                        <span>Crear Tarea</span>
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showSection('mis-tareas')">
                        <span class="icon">üìã</span>
                        <span>Mis Tareas</span>
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showSection('calificaciones')">
                        <span class="icon">üìä</span>
                        <span>Calificaciones</span>
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showSection('estudiantes')">
                        <span class="icon">üë•</span>
                        <span>Estudiantes</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Content -->
        <main class="content">
            <!-- Dashboard Section -->
            <section id="section-dashboard" class="section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalTareas">0</div>
                        <div class="stat-label">Tareas Totales</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-value" id="tareasActivas">0</div>
                        <div class="stat-label">Tareas Activas</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-value" id="entregasPendientes">0</div>
                        <div class="stat-label">Entregas Pendientes</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-value" id="totalEstudiantes">0</div>
                        <div class="stat-label">Estudiantes</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìã Tareas Recientes</h2>
                        <button class="btn btn-primary" onclick="showSection('crear-tarea')">
                            ‚ûï Nueva Tarea
                        </button>
                    </div>
                    <div id="tareasRecientes">
                        <div class="loading">Cargando tareas</div>
                    </div>
                </div>
            </section>

            <!-- Crear Tarea Section -->
            <section id="section-crear-tarea" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">‚ûï Crear Nueva Tarea</h2>
                    </div>
                    <form id="formCrearTarea" onsubmit="crearTarea(event)">
                        <div class="form-group">
                            <label for="titulo">T√≠tulo de la Tarea *</label>
                            <input type="text" id="titulo" class="form-control" required 
                                   placeholder="Ej: Ensayo sobre cambio clim√°tico">
                        </div>

                        <div class="form-group">
                            <label for="descripcion">Descripci√≥n</label>
                            <textarea id="descripcion" class="form-control" 
                                      placeholder="Instrucciones detalladas para los estudiantes..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="urlRecurso">URL de Recurso (opcional)</label>
                            <input type="url" id="urlRecurso" class="form-control" 
                                   placeholder="https://youtube.com/watch?v=...">
                        </div>

                        <div class="form-group">
                            <label>Archivo Adjunto (opcional)</label>
                            <div class="file-upload" onclick="document.getElementById('archivoAdjunto').click()">
                                <div class="icon">üìÅ</div>
                                <p>Haz clic para seleccionar un archivo</p>
                                <p style="font-size: 12px; color: #94a3b8;">PDF, DOC, PPT, im√°genes (m√°x. 20MB)</p>
                                <input type="file" id="archivoAdjunto" 
                                       accept=".pdf,.doc,.docx,.ppt,.pptx,.jpg,.jpeg,.png,.gif">
                            </div>
                            <p id="nombreArchivo" style="margin-top: 10px; color: #059669;"></p>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="fechaEntrega">Fecha de Entrega *</label>
                                <input type="datetime-local" id="fechaEntrega" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label for="puntosMaximos">Puntos M√°ximos</label>
                                <select id="puntosMaximos" class="form-control">
                                    <option value="10" selected>10 puntos</option>
                                    <option value="9">9 puntos</option>
                                    <option value="8">8 puntos</option>
                                    <option value="5">5 puntos</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="permiteTardias" checked>
                                <label for="permiteTardias">Permitir entregas tard√≠as</label>
                            </div>
                        </div>

                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                            <button type="submit" class="btn btn-primary">
                                üíæ Guardar como Borrador
                            </button>
                            <button type="button" class="btn btn-success" onclick="crearYActivarTarea()">
                                üöÄ Crear y Activar
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Mis Tareas Section -->
            <section id="section-mis-tareas" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìã Mis Tareas</h2>
                        <button class="btn btn-primary" onclick="showSection('crear-tarea')">
                            ‚ûï Nueva Tarea
                        </button>
                    </div>

                    <div class="tabs">
                        <button class="tab-btn active" onclick="filtrarTareas('todas')">Todas</button>
                        <button class="tab-btn" onclick="filtrarTareas('borrador')">Borradores</button>
                        <button class="tab-btn" onclick="filtrarTareas('activa')">Activas</button>
                        <button class="tab-btn" onclick="filtrarTareas('cerrada')">Cerradas</button>
                    </div>

                    <div id="listaTareas">
                        <div class="loading">Cargando tareas</div>
                    </div>
                </div>
            </section>

            <!-- Calificaciones Section -->
            <section id="section-calificaciones" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìä Reporte de Calificaciones</h2>
                        <button class="btn btn-secondary" onclick="exportarCalificaciones()">
                            üì• Exportar
                        </button>
                    </div>
                    <div class="table-container">
                        <div id="tablaCalificaciones">
                            <div class="loading">Cargando calificaciones</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Estudiantes Section -->
            <section id="section-estudiantes" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üë• Lista de Estudiantes</h2>
                    </div>
                    <div class="table-container">
                        <div id="listaEstudiantes">
                            <div class="loading">Cargando estudiantes</div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Ver Entregas -->
    <div id="modalEntregas" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="modalEntregasTitulo">Entregas de Tarea</h3>
                <button class="modal-close" onclick="cerrarModal('modalEntregas')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="listaEntregas">
                    <div class="loading">Cargando entregas</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Calificar -->
    <div id="modalCalificar" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Calificar Entrega</h3>
                <button class="modal-close" onclick="cerrarModal('modalCalificar')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="infoEstudiante" style="margin-bottom: 20px; color: #64748b;"></p>
                
                <div class="form-group">
                    <label for="inputCalificacion">Calificaci√≥n (1-10)</label>
                    <input type="number" id="inputCalificacion" class="form-control" 
                           min="1" max="10" required>
                </div>
                
                <div class="form-group">
                    <label for="inputComentario">Comentario (opcional)</label>
                    <textarea id="inputComentario" class="form-control" 
                              placeholder="Retroalimentaci√≥n para el estudiante..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('modalCalificar')">Cancelar</button>
                <button class="btn btn-success" onclick="guardarCalificacion()">üíæ Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Tarea -->
    <div id="modalEditarTarea" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Tarea</h3>
                <button class="modal-close" onclick="cerrarModal('modalEditarTarea')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formEditarTarea">
                    <input type="hidden" id="editTareaId">
                    
                    <div class="form-group">
                        <label for="editTitulo">T√≠tulo</label>
                        <input type="text" id="editTitulo" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="editDescripcion">Descripci√≥n</label>
                        <textarea id="editDescripcion" class="form-control"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="editUrlRecurso">URL de Recurso</label>
                        <input type="url" id="editUrlRecurso" class="form-control">
                    </div>

                    <div class="form-group">
                        <label for="editFechaEntrega">Fecha de Entrega</label>
                        <input type="datetime-local" id="editFechaEntrega" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="editPermiteTardias">
                            <label for="editPermiteTardias">Permitir entregas tard√≠as</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('modalEditarTarea')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarEdicionTarea()">üíæ Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURACI√ìN ====================
        const API_URL = 'http://127.0.0.1:8000/api';
        let currentUser = null;
        let todasLasTareas = [];
        let submissionIdActual = null;

        // ==================== UTILIDADES ====================
        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/['"\\]/g, '\\$&').replace(/\n/g, ' ');
        }

        // ==================== INICIALIZACI√ìN ====================
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar sesi√≥n
            const userCookie = getCookie('currentUser');
            const userLocal = localStorage.getItem('currentUser');
            
            if (userCookie) {
                currentUser = JSON.parse(decodeURIComponent(userCookie));
            } else if (userLocal) {
                currentUser = JSON.parse(userLocal);
            }

            if (!currentUser || currentUser.rol !== 'docente') {
                alert('Acceso denegado. Solo docentes pueden acceder.');
                window.location.href = '../login.html';
                return;
            }

            document.getElementById('userName').textContent = currentUser.nombre_completo;
            
            // Configurar archivo adjunto
            document.getElementById('archivoAdjunto').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('nombreArchivo').textContent = `üìé ${file.name}`;
                }
            });

            // Configurar fecha m√≠nima
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('fechaEntrega').min = now.toISOString().slice(0, 16);

            // Cargar datos
            cargarDashboard();
        });

        // ==================== UTILIDADES ====================
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'X-User-Id': currentUser.id_usuario
            };
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showSection(section) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));

            // Mostrar secci√≥n seleccionada
            document.getElementById(`section-${section}`).classList.add('active');
            event.target.closest('a')?.classList.add('active');

            // Cargar datos seg√∫n secci√≥n
            switch(section) {
                case 'dashboard':
                    cargarDashboard();
                    break;
                case 'mis-tareas':
                    cargarTareas();
                    break;
                case 'calificaciones':
                    cargarCalificaciones();
                    break;
                case 'estudiantes':
                    cargarEstudiantes();
                    break;
            }
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = message;
            
            const content = document.querySelector('.content');
            content.insertBefore(alertDiv, content.firstChild);
            
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // ==================== DASHBOARD ====================
        async function cargarDashboard() {
            try {
                // Cargar tareas
                const tareasRes = await fetch(`${API_URL}/tasks/`, {
                    headers: getHeaders()
                });
                const tareasData = await tareasRes.json();

                if (tareasData.success) {
                    todasLasTareas = tareasData.tareas;
                    
                    const activas = todasLasTareas.filter(t => t.estado === 'activa');
                    const pendientes = activas.reduce((sum, t) => sum + (t.total_estudiantes - t.total_entregados), 0);
                    
                    document.getElementById('totalTareas').textContent = todasLasTareas.length;
                    document.getElementById('tareasActivas').textContent = activas.length;
                    document.getElementById('entregasPendientes').textContent = pendientes;
                    
                    // Mostrar tareas recientes
                    const recientes = todasLasTareas.slice(0, 5);
                    renderTareasRecientes(recientes);
                }

                // Cargar estudiantes
                const estudiantesRes = await fetch(`${API_URL}/students/`);
                const estudiantesData = await estudiantesRes.json();
                
                if (estudiantesData.success) {
                    document.getElementById('totalEstudiantes').textContent = estudiantesData.total;
                }

            } catch (error) {
                console.error('Error cargando dashboard:', error);
            }
        }

        function renderTareasRecientes(tareas) {
            const container = document.getElementById('tareasRecientes');
            
            if (tareas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìã</div>
                        <h3>No hay tareas</h3>
                        <p>Crea tu primera tarea para comenzar</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = tareas.map(tarea => `
                <div class="task-item">
                    <div class="task-header">
                        <span class="task-title">${tarea.titulo}</span>
                        <span class="badge badge-${tarea.estado}">${tarea.estado.toUpperCase()}</span>
                    </div>
                    <div class="task-meta">
                        <span>üìÖ ${formatDate(tarea.fecha_entrega)}</span>
                        <span>üìä ${tarea.puntos_maximos} pts</span>
                        ${tarea.esta_vencida ? '<span style="color: #dc2626;">‚è∞ Vencida</span>' : ''}
                    </div>
                    ${tarea.estado !== 'borrador' ? `
                        <div class="task-stats">
                            <span class="task-stat">üë• <strong>${tarea.total_estudiantes}</strong> asignados</span>
                            <span class="task-stat">‚úÖ <strong>${tarea.total_entregados}</strong> entregados</span>
                            <span class="task-stat">üìù <strong>${tarea.total_calificados}</strong> calificados</span>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // ==================== CREAR TAREA ====================
        async function crearTarea(event) {
            event.preventDefault();
            await enviarTarea(false);
        }

        async function crearYActivarTarea() {
            await enviarTarea(true);
        }

        async function enviarTarea(activar) {
            const formData = new FormData();
            formData.append('titulo', document.getElementById('titulo').value);
            formData.append('descripcion', document.getElementById('descripcion').value);
            formData.append('url_recurso', document.getElementById('urlRecurso').value);
            formData.append('fecha_entrega', document.getElementById('fechaEntrega').value);
            formData.append('puntos_maximos', document.getElementById('puntosMaximos').value);
            formData.append('permite_tardias', document.getElementById('permiteTardias').checked);

            const archivo = document.getElementById('archivoAdjunto').files[0];
            if (archivo) {
                formData.append('archivo_adjunto', archivo);
            }

            try {
                // Crear tarea
                const response = await fetch(`${API_URL}/tasks/`, {
                    method: 'POST',
                    headers: {
                        'X-User-Id': currentUser.id_usuario
                    },
                    body: JSON.stringify({
                        titulo: document.getElementById('titulo').value,
                        descripcion: document.getElementById('descripcion').value,
                        url_recurso: document.getElementById('urlRecurso').value,
                        fecha_entrega: document.getElementById('fechaEntrega').value,
                        puntos_maximos: parseInt(document.getElementById('puntosMaximos').value),
                        permite_tardias: document.getElementById('permiteTardias').checked
                    }),
                    headers: getHeaders()
                });

                const data = await response.json();

                if (data.success) {
                    if (activar) {
                        // Activar la tarea
                        const activarRes = await fetch(`${API_URL}/tasks/${data.tarea.id}/activate/`, {
                            method: 'POST',
                            headers: getHeaders()
                        });
                        const activarData = await activarRes.json();
                        
                        if (activarData.success) {
                            showAlert(`‚úÖ ${activarData.message}`);
                        }
                    } else {
                        showAlert('‚úÖ Tarea guardada como borrador');
                    }
                    
                    // Limpiar formulario
                    document.getElementById('formCrearTarea').reset();
                    document.getElementById('nombreArchivo').textContent = '';
                    
                    // Ir a mis tareas
                    showSection('mis-tareas');
                } else {
                    showAlert(`‚ùå ${data.message}`, 'error');
                }

            } catch (error) {
                console.error('Error:', error);
                showAlert('‚ùå Error al crear la tarea', 'error');
            }
        }

        // ==================== MIS TAREAS ====================
        async function cargarTareas() {
            try {
                const response = await fetch(`${API_URL}/tasks/`, {
                    headers: getHeaders()
                });
                const data = await response.json();

                if (data.success) {
                    todasLasTareas = data.tareas;
                    renderTareas(todasLasTareas);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function filtrarTareas(estado) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            let tareasFiltradas = todasLasTareas;
            if (estado !== 'todas') {
                tareasFiltradas = todasLasTareas.filter(t => t.estado === estado);
            }
            renderTareas(tareasFiltradas);
        }

        function renderTareas(tareas) {
            const container = document.getElementById('listaTareas');

            if (tareas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìã</div>
                        <h3>No hay tareas</h3>
                        <p>No tienes tareas en esta categor√≠a</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = tareas.map(tarea => `
                <div class="task-item">
                    <div class="task-header">
                        <div>
                            <span class="task-title">${tarea.titulo}</span>
                            <span class="badge badge-${tarea.estado}" style="margin-left: 10px;">
                                ${tarea.estado.toUpperCase()}
                            </span>
                            ${tarea.esta_vencida ? '<span class="badge badge-tardia" style="margin-left: 5px;">VENCIDA</span>' : ''}
                        </div>
                        <div class="task-actions">
                            ${tarea.estado === 'borrador' ? `
                                <button class="btn btn-success btn-sm" onclick="activarTarea(${tarea.id})">
                                    üöÄ Activar
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="editarTarea(${tarea.id})">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="eliminarTarea(${tarea.id})">
                                    üóëÔ∏è Eliminar
                                </button>
                            ` : ''}
                            ${tarea.estado === 'activa' ? `
                                <button class="btn btn-primary btn-sm" onclick="verEntregas(${tarea.id})">
                                    üì• Ver Entregas
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="editarTarea(${tarea.id})">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="cerrarTarea(${tarea.id})">
                                    üîí Cerrar
                                </button>
                            ` : ''}
                            ${tarea.estado === 'cerrada' ? `
                                <button class="btn btn-primary btn-sm" onclick="verEntregas(${tarea.id})">
                                    üì• Ver Entregas
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <p style="color: #64748b; margin: 10px 0;">${tarea.descripcion || 'Sin descripci√≥n'}</p>
                    <div class="task-meta">
                        <span>üìÖ Entrega: ${formatDate(tarea.fecha_entrega)}</span>
                        <span>üìä ${tarea.puntos_maximos} pts</span>
                        <span>${tarea.permite_tardias ? '‚úÖ Permite tard√≠as' : '‚ùå No tard√≠as'}</span>
                    </div>
                    ${tarea.estado !== 'borrador' ? `
                        <div class="task-stats">
                            <span class="task-stat">üë• <strong>${tarea.total_estudiantes}</strong> asignados</span>
                            <span class="task-stat">‚úÖ <strong>${tarea.total_entregados}</strong> entregados</span>
                            <span class="task-stat">üìù <strong>${tarea.total_calificados}</strong> calificados</span>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        async function activarTarea(tareaId) {
            if (!confirm('¬øActivar esta tarea? Se asignar√° a todos los estudiantes.')) return;

            try {
                const response = await fetch(`${API_URL}/tasks/${tareaId}/activate/`, {
                    method: 'POST',
                    headers: getHeaders()
                });
                const data = await response.json();

                if (data.success) {
                    showAlert(`‚úÖ ${data.message}`);
                    cargarTareas();
                } else {
                    showAlert(`‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Error al activar tarea', 'error');
            }
        }

        async function cerrarTarea(tareaId) {
            if (!confirm('¬øCerrar esta tarea? No se permitir√°n m√°s entregas.')) return;

            try {
                const response = await fetch(`${API_URL}/tasks/${tareaId}/close/`, {
                    method: 'POST',
                    headers: getHeaders()
                });
                const data = await response.json();

                if (data.success) {
                    showAlert('‚úÖ Tarea cerrada');
                    cargarTareas();
                } else {
                    showAlert(`‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Error al cerrar tarea', 'error');
            }
        }

        async function eliminarTarea(tareaId) {
            if (!confirm('¬øEliminar esta tarea? Esta acci√≥n no se puede deshacer.')) return;

            try {
                const response = await fetch(`${API_URL}/tasks/${tareaId}/`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                const data = await response.json();

                if (data.success) {
                    showAlert('‚úÖ Tarea eliminada');
                    cargarTareas();
                } else {
                    showAlert(`‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Error al eliminar tarea', 'error');
            }
        }

        function editarTarea(tareaId) {
            const tarea = todasLasTareas.find(t => t.id === tareaId);
            if (!tarea) return;

            document.getElementById('editTareaId').value = tarea.id;
            document.getElementById('editTitulo').value = tarea.titulo;
            document.getElementById('editDescripcion').value = tarea.descripcion;
            document.getElementById('editUrlRecurso').value = tarea.url_recurso || '';
            
            // Formatear fecha para input
            const fecha = new Date(tarea.fecha_entrega);
            fecha.setMinutes(fecha.getMinutes() - fecha.getTimezoneOffset());
            document.getElementById('editFechaEntrega').value = fecha.toISOString().slice(0, 16);
            
            document.getElementById('editPermiteTardias').checked = tarea.permite_tardias;

            document.getElementById('modalEditarTarea').classList.add('active');
        }

        async function guardarEdicionTarea() {
            const tareaId = document.getElementById('editTareaId').value;

            try {
                const response = await fetch(`${API_URL}/tasks/${tareaId}/`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        titulo: document.getElementById('editTitulo').value,
                        descripcion: document.getElementById('editDescripcion').value,
                        url_recurso: document.getElementById('editUrlRecurso').value,
                        fecha_entrega: document.getElementById('editFechaEntrega').value,
                        permite_tardias: document.getElementById('editPermiteTardias').checked
                    })
                });
                const data = await response.json();

                if (data.success) {
                    showAlert('‚úÖ Tarea actualizada');
                    cerrarModal('modalEditarTarea');
                    cargarTareas();
                } else {
                    showAlert(`‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Error al actualizar tarea', 'error');
            }
        }

        // ==================== ENTREGAS ====================
        async function verEntregas(tareaId) {
            const tarea = todasLasTareas.find(t => t.id === tareaId);
            document.getElementById('modalEntregasTitulo').textContent = `Entregas: ${tarea?.titulo || ''}`;

            try {
                const response = await fetch(`${API_URL}/tasks/${tareaId}/submissions/`, {
                    headers: getHeaders()
                });
                const data = await response.json();

                if (data.success) {
                    renderEntregas(data.submissions);
                    document.getElementById('modalEntregas').classList.add('active');
                }
            } catch (error) {
                showAlert('‚ùå Error al cargar entregas', 'error');
            }
        }

        function renderEntregas(entregas) {
            const container = document.getElementById('listaEntregas');

            container.innerHTML = `
                <table class="grades-table">
                    <thead>
                        <tr>
                            <th>Estudiante</th>
                            <th>Estado</th>
                            <th>Archivos</th>
                            <th>Calificaci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${entregas.map(e => `
                            <tr>
                                <td>
                                    <strong>${e.student.nombre_completo}</strong><br>
                                    <small style="color: #64748b;">${e.student.correo}</small>
                                </td>
                                <td>
                                    <span class="badge badge-${e.estado}">${e.estado.toUpperCase()}</span>
                                    ${e.archivos.some(a => a.es_entrega_tardia) ? 
                                        '<span class="badge badge-tardia" style="margin-left: 5px;">TARD√çA</span>' : ''}
                                </td>
                                <td>
                                    ${e.archivos.length > 0 ? 
                                        e.archivos.map(a => `
                                            <a href="${API_URL.replace('/api', '')}${a.archivo}" target="_blank" 
                                               style="display: block; color: #002855; font-size: 13px;">
                                                üìé ${a.nombre_original}
                                            </a>
                                        `).join('') : 
                                        '<span style="color: #94a3b8;">Sin archivos</span>'
                                    }
                                </td>
                                <td class="grade-cell ${e.calificacion >= 8 ? 'high' : e.calificacion >= 6 ? 'medium' : e.calificacion ? 'low' : ''}">
                                    ${e.calificacion ? `${e.calificacion}/10` : '-'}
                                </td>
                                <td>
                                    ${e.estado === 'entregado' || e.estado === 'calificado' ? `
                                        <button class="btn btn-success btn-sm" 
                                                onclick="abrirCalificar(${e.id}, '${escapeHtml(e.student.nombre_completo)}', ${e.calificacion !== null ? e.calificacion : 'null'}, '${escapeHtml(e.comentario_docente || '')}')">
                                            üìù Calificar
                                        </button>
                                    ` : '<span style="color: #94a3b8;">Pendiente</span>'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function abrirCalificar(submissionId, nombre, calificacion, comentario) {
            submissionIdActual = submissionId;
            document.getElementById('infoEstudiante').textContent = `Estudiante: ${nombre}`;
            document.getElementById('inputCalificacion').value = calificacion !== null ? calificacion : '';
            document.getElementById('inputComentario').value = comentario || '';
            document.getElementById('modalCalificar').classList.add('active');
        }

        async function guardarCalificacion() {
            const calificacion = parseInt(document.getElementById('inputCalificacion').value);
            const comentario = document.getElementById('inputComentario').value;

            if (!calificacion || calificacion < 1 || calificacion > 10) {
                alert('La calificaci√≥n debe ser entre 1 y 10');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/submissions/${submissionIdActual}/grade/`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        calificacion,
                        comentario_docente: comentario
                    })
                });
                const data = await response.json();

                if (data.success) {
                    showAlert('‚úÖ Calificaci√≥n guardada');
                    cerrarModal('modalCalificar');
                    
                    // Recargar entregas
                    const tareaId = todasLasTareas.find(t => 
                        t.submissions?.some(s => s.id === submissionIdActual)
                    )?.id;
                    
                    // Cerrar y reabrir modal de entregas para actualizar
                    const modalVisible = document.getElementById('modalEntregas').classList.contains('active');
                    if (modalVisible) {
                        // Buscar la tarea actual
                        const titulo = document.getElementById('modalEntregasTitulo').textContent;
                        const tarea = todasLasTareas.find(t => titulo.includes(t.titulo));
                        if (tarea) {
                            verEntregas(tarea.id);
                        }
                    }
                } else {
                    showAlert(`‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Error al guardar calificaci√≥n', 'error');
            }
        }

        // ==================== CALIFICACIONES ====================
        async function cargarCalificaciones() {
            try {
                const response = await fetch(`${API_URL}/reports/grades/`, {
                    headers: getHeaders()
                });
                const data = await response.json();

                if (data.success) {
                    renderTablaCalificaciones(data);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderTablaCalificaciones(data) {
            const container = document.getElementById('tablaCalificaciones');

            if (data.tareas_headers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìä</div>
                        <h3>Sin datos</h3>
                        <p>No hay tareas activas o cerradas para mostrar</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <table class="grades-table">
                    <thead>
                        <tr>
                            <th>Estudiante</th>
                            ${data.tareas_headers.map(t => `<th style="text-align: center;">${t.titulo}</th>`).join('')}
                            <th style="text-align: center;">Promedio</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.reporte.map(r => `
                            <tr>
                                <td>
                                    <strong>${r.estudiante.nombre_completo}</strong><br>
                                    <small style="color: #64748b;">${r.estudiante.carrera}</small>
                                </td>
                                ${r.tareas.map(t => `
                                    <td class="grade-cell ${t.calificacion >= 8 ? 'high' : t.calificacion >= 6 ? 'medium' : t.calificacion ? 'low' : ''}">
                                        ${t.calificacion ? t.calificacion : '-'}
                                        ${t.es_tardia ? '<br><small style="color: #d97706;">(T)</small>' : ''}
                                    </td>
                                `).join('')}
                                <td class="grade-cell ${r.promedio >= 8 ? 'high' : r.promedio >= 6 ? 'medium' : r.promedio ? 'low' : ''}" style="font-size: 16px;">
                                    ${r.promedio ? r.promedio.toFixed(1) : '-'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <p style="margin-top: 15px; color: #64748b; font-size: 13px;">
                    <strong>(T)</strong> = Entrega tard√≠a | 
                    <span style="color: #059669;">‚ñ†</span> ‚â•8 | 
                    <span style="color: #d97706;">‚ñ†</span> 6-7 | 
                    <span style="color: #dc2626;">‚ñ†</span> &lt;6
                </p>
            `;
        }

        function exportarCalificaciones() {
            alert('Funci√≥n de exportaci√≥n pr√≥ximamente...');
        }

        // ==================== ESTUDIANTES ====================
        async function cargarEstudiantes() {
            try {
                const response = await fetch(`${API_URL}/students/`);
                const data = await response.json();

                if (data.success) {
                    renderEstudiantes(data.estudiantes);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderEstudiantes(estudiantes) {
            const container = document.getElementById('listaEstudiantes');

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Matr√≠cula</th>
                            <th>Nombre</th>
                            <th>Correo</th>
                            <th>Carrera</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${estudiantes.map(e => `
                            <tr>
                                <td><strong>${e.id_usuario}</strong></td>
                                <td>${e.nombre_completo}</td>
                                <td>${e.correo}</td>
                                <td>${e.carrera || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // ==================== LOGOUT ====================
        function logout() {
            localStorage.removeItem('currentUser');
            document.cookie = 'currentUser=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = '../login.html';
        }
    </script>
</body>
</html>
